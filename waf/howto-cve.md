# CVE 분류 원칙

* **Web 계층(Web Layer):** HTTP 요청을 *종단/중계/정적서빙*하는 레이어
  예) Apache **HTTPD**, **Nginx**, **IIS**, CDN/리버스 프록시, WAF 자체, HTTP 모듈(mod\_*, ngx\_*)
* **WAS 계층(App Layer):** 애플리케이션 런타임/미들웨어
  예) **Oracle WebLogic**, **IBM WebSphere**, **JBoss/WildFly**, **Apache Tomcat/Jetty**, 언어 런타임(**PHP-FPM**, **Node.js**, **.NET**), 프레임워크/라이브러리(**Spring**, **Struts2**, **Log4j**, **Shiro**, **Fastjson**, **Jackson**, **XStream** 등)

> **판단 기준:** “요청이 통과할 때 취약한 코드가 **어느 프로세스/모듈**에서 실행되는가?”

---

## 1) 대표 CVE 유형 매핑

| 계층      | 컴포넌트(예)         | 전형적 취약점 유형                                                                         | 대표 예시 CVE/취약점                                                                                         | 공격면(요약)                  | 즉시 대응 포인트                                |
| ------- | --------------- | ---------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------- | ------------------------ | ---------------------------------------- |
| **Web** | Apache HTTPD    | **경로 우회/디렉토리 트래버설**, 정규식 파서 버그, 모듈 취약점(mod\_cgi, mod\_proxy 등)                     | CVE-2021-41773/42013(경로우회→RCE), CVE-2019-0211                                                         | **URI·메서드·헤더** 중심        | WAF: 경로/확장자/메서드 정밀 필터, 서버: 버전/모듈 최소화     |
|         | Nginx           | 리졸버/업스트림 파서, chunk 해석, 3rd 파서                                                      | CVE-2021-23017(Resolver), CVE-2013-2028                                                               | **URI/헤더/업스트림**          | WAF: 헤더/URI 혼합 방어, 서버: 안전 옵션·업스트림 검증     |
|         | IIS             | WebDAV/CGI 핸들러 취약점                                                                 | CVE-2017-7269(WebDAV RCE)                                                                             | **메서드/핸들러**              | 불필요 핸들러 제거, 메서드 제한                       |
| **WAS** | **WebLogic**    | **XMLDecoder/WorkContext RCE**, Console 인증우회                                       | **CVE-2017-10271**, 2018-2628, 2019-2725, 2020-14882/14883                                            | **특정 경로+XML 바디**         | WAF: 좁은 스코프+XML on-demand, 서버: 패치·콘솔 비공개 |
|         | WebSphere       | Java 디시리얼라이제이션                                                                     | 2020-4450 등                                                                                           | **직렬화 오브젝트**             | WAF: 시그니처+사전 차단 어려움→패치·네트워크 분리           |
|         | JBoss/WildFly   | JMXInvoker/디시리얼라이제이션                                                               | CVE-2017-12149 등                                                                                      | **바이너리/직렬화**             | 관리 포트 외부 차단, 패치                          |
|         | **Tomcat**      | **AJP Ghostcat**, PUT RCE 설정오류                                                     | **CVE-2020-1938**, CVE-2017-12615                                                                     | **프로토콜(AJP)/메서드**        | AJP 비노출, PUT 제한, 패치                      |
|         | **프레임워크/라이브러리** | **Log4Shell**, Spring4Shell, Struts2 RCE, Shiro 키 탈취, Fastjson/Jackson/XStream 직렬화 | **Log4j(CVE-2021-44228)**, **Spring4Shell(2022-22965)**, **Struts2(2017-5638)**, **Shiro(2016-4437)** | **헤더/파라미터/바디가 앱 코드로 유입** | WAF: 패턴 일부 차단 가능하나 **패치/버전업**이 본질        |

> **요지:** Web 계층 취약점은 **URI/메서드/헤더** 같은 **표면 신호**로 방어 효과가 높고, WAS 계층은 **본문/프로토콜/직렬화** 등 **애플리케이션 맥락**이 필요해 **패치·노출축소**가 결정적입니다.

---

## 2) 분류에 따른 **WAF 룰 전략**

### A. Web 계층(CVE 우선 적용 대상)

* **룰 형태:** 경로·메서드·확장자·헤더 기반, 본문 파싱 최소화
* **예:** `..%2f` 경로우회, `TRACE/PROPFIND/PUT` 제한, WebDAV/CGI 비활성
* **장점:** **낮은 성능 비용**으로 고효율 차단
* **우선순위:** **높음**(환경 공통·표면 노출)

### B. WAS 계층(CVE 선택적/스코프 제한 적용)

* **룰 형태:** 특정 **가상호스트/경로** + **메서드/헤더**로 **강 스코프**, 필요 시에만 XML/JSON 파서 온디맨드
* **예:** WebLogic `/wls-wsat/` + `POST` + `Content-Type:text/xml` + WorkContext 키워드
* **장점:** 오탐·성능비용 통제
* **우선순위:** **환경 존재 시 높음**, **미존재 시 비활성**(옵션 탐지만)

---

## 3) 경계/혼합 사례 정리

| 케이스                    | 분류 가이드        | 메모                                         |
| ---------------------- | ------------- | ------------------------------------------ |
| **PHP-FPM, CGI, AJP**  | WAS/런타임 측면 강함 | Web 서버 설정 취약(메서드/핸들러 노출)은 Web, 런타임 버그는 WAS |
| **리버스 프록시/로드밸런서 플러그인** | Web           | 모듈 버그는 Web로 분류                             |
| **Log4j/라이브러리**        | WAS           | 헤더 기반 탐지 도움은 가능하나 **패치가 핵심**               |
| **WAF 자체 취약점**         | Web           | 장비/서비스 자체 패치 필요                            |

---

## 4) **의사결정 체크리스트**(룰 온보딩)

1. **적용성**: 해당 컴포넌트가 우리 환경에 **존재**하는가?
2. **노출도**: 외부 경로/포트가 **열려** 있는가? (예: `/wls-wsat/`, AJP, WebDAV)
3. **영향도×악용 용이성**: RCE/인증 우회 + 공개 PoC 여부
4. **대체 통제**: 패치 상태, 네트워크 분리, 인증, VPN 뒤 배치 여부
5. **성능 비용**: 본문 파싱/복잡 정규식 필요 여부
   → **결정:** `차단` / `탐지 전용(스코프 제한)` / `비활성(근거 기록·주기 재평가)`

---

## 5) 우선순위 샘플 맵(요약)

* **우리 스택: Apache HTTPD + Tomcat** (WebLogic 없음)

  * **적용(차단):** HTTPD 경로/메서드계열(41773/42013), Tomcat AJP(1938) *노출 시*
  * **탐지만:** WebLogic 10271 (경량 스코프 관측)
  * **비활성:** WebSphere/JBoss 전용

* **우리 스택: Nginx + WebLogic(외부 노출)**

  * **적용(차단):** WebLogic 10271/14882 등 **정밀 스코프** + Nginx 표면 취약점
  * **탐지/비활성:** Struts/Log4j는 **패치/버전관리**가 1순위, WAF는 보조

---

## 6) 예시 룰 스니펫(핵심만 재정리)

### Web(HTTPD) — 경로우회 방어(개념)

* `..`, `%2f`, `.%2e/` 패턴 → 정규식 최소화, **정규화 후 비교**
* 위험 메서드(`TRACE/PUT/PROPFIND`) 거부, 특정 핸들러 비활성

### WAS(WebLogic) — CVE-2017-10271

* **스코프:** `/wls-wsat/` + `POST` + `Content-Type:text/xml`
* **본문:** 필요 시 **XML 파서 on-demand**, `WorkContext`, `XMLDecoder` 등 **다중 문자열(@pm)**

---

## 7) 운영 지표

* **성능:** 룰 추가 전후 p95/99, CPU, 본문 파서 hit율
* **탐지품질:** 룰별 hit/block, 오탐 케이스 비율
* **보안효과:** 취약 컴포넌트 노출 축소(포트/경로), 재발 빈도

---

### 결론 문장(한 줄)

> **Web/WAS로 CVE를 분류해, Web 계층은 표면 신호 중심의 저비용 차단을, WAS 계층은 “존재·노출되는 구간에 한해” 정밀 스코프+패치 중심으로 운영**하는 것이 최적입니다.
